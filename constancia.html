<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador de Cartas de Constancia</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 70px 40px 40px 40px; 
            background-image: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)), url('main2.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            background-attachment: fixed;
            background-color: #f0f0f0; 
            color: #000;
        }
        
        h1, h2, h3 { text-align: center; }
        h1 { color: #000; margin: 0 0 6px; }
        h2 { color: #000; margin-bottom: 20px; }
        h3 { 
            color: #333; 
            font-size: 16px; 
            margin: 0 0 8px 0; 
            text-align: left;
        }

        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 20px; 
            background-color: #333; 
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 100;
            box-sizing: border-box; 
        }
        
        #fecha-actualizacion {
            font-size: 14px;
            color: #FFD700;
        }

        #boton-container {
            display: flex;
            align-items: center;
        }

        #top-bar button {
            margin-left: 10px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #FFD700;
            border-radius: 4px;
            background-color: #000;
            color: #FFD700;
            font-weight: bold;
            white-space: nowrap;
        }

        #btn-masivo { background-color: #FFD700; color: #000; border-color: #FFD700; }
        #btn-limpiar { background-color: #999; color: #000; border-color: #777; }

        #top-bar button:hover { background-color: #FFD700; color: #000; }
        
        .logo-wrap { text-align: center; margin-top: 50px; margin-bottom: 16px; }

        input, select {
            padding: 10px;
            background-color: #fff;
            color: #000;
            border: 1px solid #333;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%;
        }
        .btn-generar { 
            padding: 4px 8px; 
            cursor: pointer;
            border: 1px solid #333; 
            background-color: #555;
            color: #FFD700;
            border-radius: 4px;
        }
        .btn-generar:hover { background-color: #FFD700; color: #000; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.9);
        }
        th, td { border: 1px solid #333; padding: 8px; text-align: left; font-size: 14px; }
        thead { background-color: #666; color: #FFD700; }
    </style>
</head>
<body>
    <script>
        // *** SEGURIDAD Y SESIÓN ***
        if (localStorage.getItem('sesionCanguro') !== 'activa') {
            window.location.href = 'iniciar-sesion.html';
        }

        function cerrarSesion() {
            localStorage.removeItem('sesionCanguro');
            window.location.href = 'iniciar-sesion.html';
        }

        function irAmonestacion() { window.location.href = 'amonestacion.html'; }
        
        function actualizarFechaHora() {
            const now = new Date();
            const fecha = now.toLocaleDateString('es-VE', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const hora = now.toLocaleTimeString('es-VE', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            const elemento = document.getElementById('fecha-actualizacion');
            if (elemento) elemento.textContent = `Actualizado: ${fecha} ${hora}`;
            setTimeout(actualizarFechaHora, 1000);
        }

        function generarCartasMasivas() {
            const checkboxesSeleccionados = document.querySelectorAll('#cuerpo-tabla input[type="checkbox"]:checked');
            if (checkboxesSeleccionados.length === 0) {
                alert("Seleccione al menos un empleado.");
                return;
            }
            if (confirm(`¿Generar ${checkboxesSeleccionados.length} cartas?`)) {
                checkboxesSeleccionados.forEach(checkbox => {
                    const emp = empleados.find(e => e.cedula === checkbox.value);
                    if (emp) abrirCarta(emp);
                });
                setTimeout(limpiarSeleccion, 1000); 
            }
        }

        function limpiarSeleccion() {
            document.querySelectorAll('#cuerpo-tabla input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
    </script>
    
    <div id="top-bar">
        <div id="fecha-actualizacion"></div> 
        <div id="boton-container">
            <button id="btn-limpiar" onclick="limpiarSeleccion()">Limpiar selección</button> 
            <button id="btn-masivo" onclick="generarCartasMasivas()">Generar Cartas Masivas</button> 
            <button onclick="irAmonestacion()">Ir a Amonestación</button>
            <button onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
    </div>

    <div class="logo-wrap">
        <img src="logo-can2.png" alt="Logo Canguro" style="height: 100px;"/>
        <h1>Generador de Cartas de Trabajo Canguro Venezuela</h1>
    </div>
    
    <h2>Empleados Activos Organizacional</h2>
    
    <div style="max-width: 1000px; margin: 0 auto 20px; display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>Filtrar por Cédula o Nombre:</h3>
            <input type="text" id="filtro-nombre" placeholder="Buscar..." />
        </div>
        <div style="flex: 1;">
            <h3>Filtrar por Estado:</h3>
            <select id="filtro-estado">
                <option value="todos">Mostrar Todos</option>
                <option value="activo">Activos</option>
                <option value="egreso">Egresados</option>
            </select>
        </div>
    </div>

    <div id="contenedor-principal" style="max-width: 1000px; margin: 0 auto;">
        <table id="tabla-empleados">
            <thead>
                <tr>
                    <th>Sel.</th>
                    <th>Cédula</th>
                    <th>Nombre</th>
                    <th>Cargo</th>
                    <th>Ingreso</th>
                    <th>Egreso</th>
                    <th>Sueldo</th>
                    <th>Razón</th>
                    <th>Generar</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla"></tbody>
        </table>
    </div>

    <script>
        const SHEET_ID = '19i5pwrIx8RX0P2OkE1qY2o5igKvvv2hxUuvb9jM_8LE'; 
        const API_KEY  = 'AIzaSyD8Su9VTM_oynBtrPvVA4zRyeu-UjeEJDw'; 
        const RANGE    = 'Empleados!A2:O'; 

        let empleados = [];

        function abrirCarta({ cedula, nombre, cargo, ingreso, egreso, sueldo, razon, rif, direccion }) {
            const fecha = new Date();
            const dia = fecha.getDate();
            const mes = fecha.toLocaleString('es-VE', { month: 'long' });
            const año = fecha.getFullYear();
            const esActivo = !egreso || egreso.trim() === '';

            const cuerpo = esActivo
                ? `Por medio de la presente se hace constar que el ciudadano (a) <strong>${nombre}</strong>, venezolano (a), mayor de edad y portador de la cédula de identidad N° <strong>${cedula}</strong>, labora en esta empresa desde el día ${ingreso}, en el cargo de <strong>${cargo}</strong>, devengando un salario mensual de <strong>${sueldo}</strong>.`
                : `Por medio de la presente se hace constar que el ciudadano (a) <strong>${nombre}</strong>, venezolano (a), mayor de edad y portador de la cédula de identidad N° <strong>${cedula}</strong>, laboró en esta empresa desde el día ${ingreso} hasta la fecha ${egreso}, en el cargo de <strong>${cargo}</strong>, devengando un salario mensual de <strong>${sueldo}</strong>.`;

            // NOMBRE DE ARCHIVO CORREGIDO: firma jeanete.png (una sola 't')
            const firmaPath = `firma jeanete.png`; 

            const html = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8" />
                    <title>Constancia - ${nombre}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 0; padding: 40px; color:#000; line-height: 1.6; }
                        .marca-agua { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.08; z-index: -1; }
                        .firma-contenedor { margin-top: 50px; text-align: center; position: relative; }
                        .firma-img { height: 160px; width: auto; display: block; margin: 0 auto -25px auto; position: relative; z-index: 10; }
                        .firma-texto { position: relative; z-index: 5; margin: 0; }
                        @media print { body { padding: 0; } .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <div class="marca-agua"><img src='logo-canguro.png' style="height:190px;" /></div>
                    <div style="max-width:650px; margin:0 auto;">
                        <div style="margin-bottom:150px; text-align: left;">
                            <strong>${razon}</strong><br><strong>RIF:</strong> ${rif}
                        </div>
                        <h2 style="text-align:center; text-decoration:underline; font-size: 18px;">A QUIEN PUEDA INTERESAR</h2>
                        <p style="text-align:justify; margin-top:40px;">${cuerpo}</p>
                        <p style="text-align:justify;">Constancia que se expide por la parte interesada en Caracas a los ${dia} días del mes de ${mes} del año ${año}.</p>
                        
                        <div class="firma-contenedor">
                            <img src="${firmaPath}" class="firma-img" alt="Firma">
                            <p class="firma-texto"><strong>JEANETTE ARVELO</strong><br>DIRECTORA DE RECURSOS HUMANOS</p>
                        </div>

                        <div style="text-align:center; font-size:11px; margin-top:110px; border-top:1px solid #000; padding-top:5px;">
                            Dirección: ${direccion}
                        </div>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                win.focus();
                // Tiempo de espera para que cargue la imagen antes de imprimir
                setTimeout(() => { win.print(); }, 750);
            } else {
                alert("Habilita las ventanas emergentes.");
            }
        }

        async function cargarEmpleados() {
            actualizarFechaHora();
            try {
                const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`);
                const data = await res.json();
                empleados = (data.values || []).map(row => ({
                    cedula: row[0] || '', nombre: row[1] || '', cargo: row[2] || '',
                    ingreso: row[3] || '', egreso: row[4] || '', sueldo: row[5] || '',
                    razon: row[6] || '', rif: row[12] || 'N/A', direccion: row[13] || 'N/A'
                }));
                aplicarFiltros();
            } catch (e) { console.error(e); }
        }

        function aplicarFiltros() {
            const texto = document.getElementById('filtro-nombre').value.toLowerCase();
            const estado = document.getElementById('filtro-estado').value;
            const filtrados = empleados.filter(emp => {
                const matchT = emp.nombre.toLowerCase().includes(texto) || emp.cedula.includes(texto);
                const activo = !emp.egreso || emp.egreso.trim() === '';
                const matchE = (estado === 'todos') || (estado === 'activo' && activo) || (estado === 'egreso' && !activo);
                return matchT && matchE;
            });
            renderTabla(filtrados);
        }

        function renderTabla(lista) {
            const cuerpo = document.getElementById('cuerpo-tabla');
            cuerpo.innerHTML = '';
            lista.forEach(emp => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" value="${emp.cedula}"></td>
                    <td>${emp.cedula}</td>
                    <td>${emp.nombre}</td>
                    <td>${emp.cargo}</td>
                    <td>${emp.ingreso}</td>
                    <td>${emp.egreso}</td>
                    <td>${emp.sueldo}</td>
                    <td>${emp.razon}</td>
                    <td><button class="btn-generar" onclick='abrirCarta(${JSON.stringify(emp).replace(/'/g, "&apos;")})'>Generar</button></td>
                `;
                cuerpo.appendChild(tr);
            });
        }

        document.getElementById('filtro-nombre').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-estado').addEventListener('change', aplicarFiltros);
        cargarEmpleados();
    </script>
</body>
</html>