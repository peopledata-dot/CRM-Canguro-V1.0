<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generador de Cartas de Constancia</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            /* Ajustamos el margen superior para que el contenido no quede bajo la barra fija */
            margin: 70px 40px 40px 40px; 
            
            /* --- FONDO CON IMAGEN FIJA Y TRANSPARENCIA BLANCA --- */
            /* Capa blanca semi-transparente (0.5 opacity) sobre la imagen */
            background-image: linear-gradient(rgba(255, 255, 255, 0.5), rgba(255, 255, 255, 0.5)), url('main2.png'); 
            background-size: cover; 
            background-position: center; 
            background-repeat: no-repeat;
            background-attachment: fixed; /* Fondo fijo */
            
            /* Fondo de fallback */
            background-color: #f0f0f0; 
            color: #000; /* Texto negro para mejor contraste sobre fondo blanco/claro */
        }
        
        h1, h2, h3 { text-align: center; }
        h1 { color: #000; margin: 0 0 6px; } /* Texto oscuro para el fondo claro */
        h2 { color: #000; margin-bottom: 20px; } /* Texto oscuro */
        h3 { 
            color: #333; /* Gris oscuro para títulos de filtros */
            font-size: 16px; 
            margin: 0 0 8px 0; 
            text-align: left;
        }

        /* --- ESTILOS DE NAVEGACIÓN SUPERIOR --- */
        #top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding: 10px 20px; 
            background-color: #333; /* Barra oscura */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
            z-index: 100;
            box-sizing: border-box; 
        }
        
        #fecha-actualizacion {
            font-size: 14px;
            color: #FFD700; /* Dorado para la fecha */
        }

        #boton-container {
            display: flex;
            align-items: center;
        }

        #top-bar button {
            margin-left: 10px;
            padding: 8px 15px;
            font-size: 14px;
            cursor: pointer;
            border: 1px solid #FFD700;
            border-radius: 4px;
            background-color: #000;
            color: #FFD700;
            font-weight: bold;
            white-space: nowrap;
        }
        /* Estilos específicos para botones funcionales */
        #btn-masivo, #btn-limpiar {
            font-weight: bold;
        }

        #btn-masivo {
            background-color: #FFD700;
            color: #000;
            border-color: #FFD700;
        }
        #btn-limpiar {
            background-color: #999; /* Gris claro para el botón de limpiar */
            color: #000;
            border-color: #777;
        }

        /* Estilos Hover */
        #top-bar button:not(#btn-masivo):not(#btn-limpiar):hover {
            background-color: #FFD700;
            color: #000;
        }
        #btn-masivo:hover {
             background-color: #000;
             color: #FFD700;
        }
        #btn-limpiar:hover {
             background-color: #FFD700;
             color: #000;
        }
        
        .logo-wrap { 
            text-align: center; 
            margin-top: 50px; 
            margin-bottom: 16px; 
        }
        /* --- FIN ESTILOS DE NAVEGACIÓN SUPERIOR --- */

        input, select {
            padding: 10px;
            margin: 0;
            background-color: #fff; /* Fondo blanco */
            color: #000; /* Texto negro */
            border: 1px solid #333;
            border-radius: 4px;
            box-sizing: border-box;
            width: 100%;
        }
        .btn-generar { 
            padding: 4px 8px; 
            margin: 0; 
            width: auto; 
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid #333; 
            background-color: #555; /* Botón oscuro */
            color: #FFD700;
            border-radius: 4px;
        }
        .btn-generar:hover {
            background-color: #FFD700;
            color: #000;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: rgba(255, 255, 255, 0.9); /* Fondo de tabla semi-transparente blanco */
            color: #000; /* Texto negro en la tabla */
        }
        th, td {
            border: 1px solid #333; /* Borde oscuro */
            padding: 8px;
            text-align: left;
            font-size: 14px;
        }
        thead {
            background-color: #666; /* Fondo de encabezado gris */
            color: #FFD700;
        }
        input[type="checkbox"] {
            width: auto; 
            margin: 0;
            accent-color: #FFD700; /* Color del checkbox al ser seleccionado */
            background-color: #fff;
        }
    </style>
</head>
<body>
    <script>
        // *** FUNCIONES DE NAVEGACIÓN Y SESIÓN ***
        if (localStorage.getItem('sesionCanguro') !== 'activa') {
            window.location.href = 'iniciar-sesion.html';
        }

        function cerrarSesion() {
            localStorage.removeItem('sesionCanguro');
            window.location.href = 'iniciar-sesion.html';
        }
        function irAmonestacion() {
            window.location.href = 'amonestacion.html';
        }
        
        // *** FUNCIÓN PARA ACTUALIZAR LA FECHA/HORA ***
        function actualizarFechaHora() {
            const now = new Date();
            const fecha = now.toLocaleDateString('es-VE', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const hora = now.toLocaleTimeString('es-VE', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            const elemento = document.getElementById('fecha-actualizacion');
            if (elemento) {
                elemento.textContent = `Actualizado: ${fecha} ${hora}`;
            }
            setTimeout(actualizarFechaHora, 1000); // Refresca cada segundo
        }

        // *** FUNCIÓN DE GENERACIÓN MASIVA ***
        function generarCartasMasivas() {
            const checkboxesSeleccionados = document.querySelectorAll('#cuerpo-tabla input[type="checkbox"]:checked');
            
            if (checkboxesSeleccionados.length === 0) {
                alert("Debes seleccionar al menos un empleado marcando la casilla al lado de la cédula.");
                return;
            }

            const listaSeleccionada = [];
            checkboxesSeleccionados.forEach(checkbox => {
                const cedulaTarget = checkbox.value;
                const empleado = empleados.find(emp => emp.cedula === cedulaTarget);
                if (empleado) {
                    listaSeleccionada.push(empleado);
                }
            });

            const confirmacion = confirm(`¿Estás seguro de generar ${listaSeleccionada.length} cartas de constancia seleccionadas? Esto abrirá múltiples ventanas de impresión.`);
            
            if (confirmacion) {
                listaSeleccionada.forEach(emp => {
                    abrirCarta(emp);
                });
                // Llama a limpiarSeleccion después de la generación masiva
                // Nota: Los navegadores pueden bloquear la impresión masiva si no se habilita.
                setTimeout(limpiarSeleccion, 1000); 
            }
        }

        // *** FUNCIÓN: LIMPIAR SELECCIÓN ***
        function limpiarSeleccion() {
            const checkboxes = document.querySelectorAll('#cuerpo-tabla input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            // Opcional: mostrar un mensaje de limpieza, pero si se llama después de impresión masiva puede ser molesto.
            // alert('Selección limpiada.');
        }

    </script>
    
    <div id="top-bar">
        <div id="fecha-actualizacion"></div> 
        
        <div id="boton-container">
            <button id="btn-limpiar" onclick="limpiarSeleccion()">Limpiar selección</button> 
            <button id="btn-masivo" onclick="generarCartasMasivas()">Generar Cartas Masivas</button> 
            <button onclick="irAmonestacion()">Ir a Amonestación</button>
            <button onclick="cerrarSesion()">Cerrar sesión</button>
        </div>
    </div>

    <div class="logo-wrap">
        <img src="logo-can2.png" alt="Logo Canguro" style="height: 100px;"/>
        <h1>Generador de Cartas de Trabajo Canguro Venezuela</h1>
    </div>
    
    <h2 style="color: #000;">Empleados Activos Organizacional</h2>
    
    <div style="max-width: 1000px; margin: 0 auto 20px; display: flex; gap: 20px;">
        <div style="flex: 1;">
            <h3>Filtrar por Cédula o Nombre:</h3>
            <input type="text" id="filtro-nombre" placeholder="Buscar por Cédula o Nombre..." />
        </div>
        <div style="flex: 1;">
            <h3>Filtrar por Estado:</h3>
            <select id="filtro-estado">
                <option value="todos">Mostrar Todos</option>
                <option value="activo">Activos</option>
                <option value="egreso">Egresados</option>
            </select>
        </div>
    </div>
    <div id="contenedor-principal" style="max-width: 1000px; margin: 0 auto;">
        <table id="tabla-empleados">
            <thead>
                <tr>
                    <th>Sel.</th>
                    <th>Cédula</th>
                    <th>Nombre</th>
                    <th>Cargo</th>
                    <th>Ingreso</th>
                    <th>Egreso</th>
                    <th>Sueldo</th>
                    <th>Razón</th>
                    <th>Generar</th>
                </tr>
            </thead>
            <tbody id="cuerpo-tabla"></tbody>
        </table>
    </div>

    <script>
        // Config Sheets
        const SHEET_ID = '19i5pwrIx8RX0P2OkE1qY2o5igKvvv2hxUuvb9jM_8LE'; 
        const API_KEY  = 'AIzaSyD8Su9VTM_oynBtrPvVA4zRyeu-UjeEJDw'; 
        const RANGE    = 'Empleados!A2:O'; 

        let empleados = [];

        // Plantilla de carta y apertura para PDF (Print)
        function abrirCarta({ cedula, nombre, cargo, ingreso, egreso, sueldo, razon, rif, direccion }) {
            const fecha = new Date();
            const dia = fecha.getDate();
            const mes = fecha.toLocaleString('es-VE', { month: 'long' });
            const año = fecha.getFullYear();

            const esActivo = !egreso || egreso.trim() === '';

            const cuerpo = esActivo
                ? `Por medio de la presente se hace constar que el ciudadano (a) <strong>${nombre}</strong>, venezolano (a), mayor de edad y portador de la cédula de identidad N° <strong>${cedula}</strong>, labora en esta empresa desde el día ${ingreso}, en el cargo de <strong>${cargo}</strong>, devengando un salario mensual de <strong>${sueldo}</strong>.`
                : `Por medio de la presente se hace constar que el ciudadano (a) <strong>${nombre}</strong>, venezolano (a), mayor de edad y portador de la cédula de identidad N° <strong>${cedula}</strong>, laboró en esta empresa desde el día ${ingreso} hasta la fecha ${egreso}, en el cargo de <strong>${cargo}</strong>, devengando un salario mensual de <strong>${sueldo}</strong>.`;

            const firmaPath = `${rif}.png`; 

            const html = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8" />
                    <title>Constancia de Trabajo</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; color:#000; }
                        h2 { text-align: center; font-size:16px; margin-bottom:10px; }
                        p  { margin: 8px 0; }
                        .firma { margin-top: 80px; text-align: center; }
                        @media print {
                            @page { margin: 0; }
                            body  { margin: 0; }
                        }
                    </style>
                </head>
                <body>
                    <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0.08; z-index: 0;">
                        <img src='logo-canguro.png' alt='Logo Canguro' style="height:190px;" />
                    </div>

                    <div style="width:600px; margin:0 auto; text-align:center;">
                        <div style="text-align:left; font-size:15px; margin-bottom:230px;">
                            <strong>${razon}</strong><br />
                            <strong>RIF:</strong> ${rif}
                        </div>
                        <h2>A QUIEN PUEDA INTERESAR</h2>
                        <p style="text-align:justify;">${cuerpo}</p>
                        <p style="text-align:justify;">
                            Constancia que se expide por la parte interesada en Caracas a los ${dia} días del mes de ${mes} del año ${año}.
                        </p>
                        <div class="firma" style="margin-top:60px; text-align:center;">
                            <img src="${firmaPath}" alt="Firma" style="height:150px; display:block; margin:0 auto;" />
                            <p style="margin:2px 0;"><strong>JEANETTE JULIETA ARVELO GOMEZ</strong></p>
                            <p style="margin:0;">DIRECTORA DE RECURSOS HUMANOS</p>
                        </div>
                        <p style="text-align:center; font-size:14px; margin-top:130px;">
                            Dirección: ${direccion}
                        </p>
                    </div>
                </body>
                </html>
            `;

            const win = window.open('', '_blank');
            if (win) {
                win.document.write(html);
                win.document.close();
                win.focus();
                win.print(); 
            } else {
                alert("El navegador bloqueó la ventana emergente. Habilita popups.");
            }
        }
        
        /**
         * Renderiza la tabla con la lista de empleados proporcionada.
         * @param {Array} lista - La lista filtrada de empleados.
         */
        function renderTabla(lista) {
            const cuerpo = document.getElementById('cuerpo-tabla');
            cuerpo.innerHTML = ''; 

            lista.forEach((emp) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="select-empleado" value="${emp.cedula}"></td>
                    <td>${emp.cedula}</td>
                    <td>${emp.nombre}</td>
                    <td>${emp.cargo}</td>
                    <td>${emp.ingreso}</td>
                    <td>${emp.egreso}</td>
                    <td>${emp.sueldo}</td>
                    <td>${emp.razon}</td>
                    <td><button class="btn-generar" data-cedula="${emp.cedula}">Generar</button></td>
                `;
                cuerpo.appendChild(tr);
            });
        }

        /**
         * Aplica los filtros de búsqueda por nombre/cédula y estado (activo/egreso)
         * y llama a la función de renderizado.
         */
        function aplicarFiltros() {
            const textoFiltro = document.getElementById('filtro-nombre').value.toLowerCase();
            const estadoFiltro = document.getElementById('filtro-estado').value;

            const listaFiltrada = empleados.filter(emp => {
                const coincideTexto = emp.nombre.toLowerCase().includes(textoFiltro) || 
                                     emp.cedula.toLowerCase().includes(textoFiltro);

                const esActivo = !emp.egreso || emp.egreso.trim() === '';
                let coincideEstado = true;
                
                if (estadoFiltro === 'activo') {
                    coincideEstado = esActivo;
                } else if (estadoFiltro === 'egreso') {
                    coincideEstado = !esActivo;
                }
                
                return coincideTexto && coincideEstado;
            });

            renderTabla(listaFiltrada);
        }
        
        // Carga empleados desde Google Sheets
        async function cargarEmpleados() {
            actualizarFechaHora();
            
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
            try {
                const res = await fetch(url);
                const data = await res.json();

                empleados = (data.values || []).map(row => {
                    return {
                        cedula: row[0] || '',
                        nombre: row[1] || '',
                        cargo:  row[2] || '',
                        ingreso: row[3] || '',
                        egreso: row[4] || '',
                        sueldo: row[5] || '',
                        razon:  row[6] || '',
                        rif: row[12] || 'N/A', 
                        direccion: row[13] || 'N/A' 
                    };
                });
                
                aplicarFiltros(); 
            } catch (err) {
                console.error("Error al cargar datos de Google Sheets:", err);
                alert('Error al cargar empleados. Revisa tu SHEET_ID y API_KEY.');
                const cuerpo = document.getElementById('cuerpo-tabla');
                cuerpo.innerHTML = `<tr><td colspan="9">Error de conexión con Google Sheets. Revisa la consola (F12) para más detalles.</td></tr>`;
            }
        }

        // Listener para botones individuales
        document.addEventListener('click', e => {
            if (e.target.classList.contains('btn-generar')) {
                const cedulaTarget = e.target.dataset.cedula;
                const empleado = empleados.find(emp => emp.cedula === cedulaTarget);
                if (empleado) {
                    abrirCarta(empleado);
                }
            }
        }); 

        // Listeners para los filtros
        document.getElementById('filtro-nombre').addEventListener('input', aplicarFiltros);
        document.getElementById('filtro-estado').addEventListener('change', aplicarFiltros);
        
        // Inicialización
        cargarEmpleados();
    </script>
</body>
</html>